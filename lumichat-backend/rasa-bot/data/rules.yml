version: "3.1"

rules:

# ------------------------------
# SIMPLE INTENTS
# ------------------------------
- rule: respond to greeting
  steps:
    - intent: greet
    - action: utter_greet

- rule: respond to sadness
  steps:
    - intent: express_sadness
    - action: action_reflective_support

- rule: respond to anxiety
  steps:
    - intent: express_anxiety
    - action: action_reflective_support

- rule: respond to stress
  steps:
    - intent: express_stress
    - action: action_reflective_support

- rule: respond to happiness
  steps:
    - intent: express_happiness
    - action: action_reflective_support

- rule: respond to smalltalk
  steps:
    - intent: smalltalk
    - action: utter_smalltalk_default

- rule: respond to thanks
  steps:
    - intent: thank
    - action: utter_thanks

- rule: respond to goodbye
  steps:
    - intent: goodbye
    - action: utter_goodbye

# ------------------------------
# CRISIS HANDLING
# ------------------------------
- rule: crisis protocol
  condition:
    - active_loop: null
  steps:
    - intent: crisis_help
    - action: utter_crisis_intro
    - action: utter_crisis_hotlines
    - action: utter_crisis_next_steps   # <-- this asks "proceed to appointment?"

# NEW: After crisis next-steps prompt, user says yes → send link
- rule: after crisis next steps, affirm → submit appointment
  steps:
    - action: utter_crisis_next_steps
    - intent: affirm
    - action: action_submit_appointment

# ------------------------------
# APPOINTMENT FORM LIFECYCLE
# ------------------------------
- rule: start appointment form with empathy
  steps:
    - intent: book_appointment
    - action: action_reflective_support
    - action: appointment_form
    - active_loop: appointment_form

# FIXED: outside any form, a plain affirm can submit appointment (e.g. generic offer flows)
- rule: outside form, affirm → submit appointment
  condition:
    - active_loop: null
  steps:
    - intent: affirm
    - action: action_submit_appointment

# accept date while the form runs
- rule: accept inform_date during appointment form
  condition:
    - active_loop: appointment_form
  steps:
    - intent: inform_date
    - action: appointment_form

# accept time while the form runs
- rule: accept inform_time during appointment form
  condition:
    - active_loop: appointment_form
  steps:
    - intent: inform_time
    - action: appointment_form

# NEW: accept affirm (consent) while the form runs
- rule: accept affirm during appointment form (consent)
  condition:
    - active_loop: appointment_form
  steps:
    - intent: affirm
    - action: appointment_form

# cancel form on deny
- rule: cancel appointment form on deny
  condition:
    - active_loop: appointment_form
  steps:
    - intent: deny
    - action: action_deactivate_loop
    - active_loop: null
    - action: utter_goodbye

# submit after all required slots filled
- rule: submit appointment form
  condition:
    - active_loop: appointment_form
  steps:
    - action: appointment_form
    - active_loop: null
    - action: action_submit_appointment

# ------------------------------
# OUT OF SCOPE / FALLBACK
# ------------------------------
- rule: handle out of scope
  steps:
    - intent: out_of_scope
    - action: utter_out_of_scope

- rule: nlu fallback
  steps:
    - intent: nlu_fallback
    - action: utter_fallback
