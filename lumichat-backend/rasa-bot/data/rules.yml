version: "3.1"

rules:

# =========================
# SIMPLE INTENTS â†’ RESPONSES/ACTIONS
# =========================
- rule: respond to greeting
  steps:
    - intent: greet
    - action: utter_greet

- rule: respond to sadness
  steps:
    - intent: express_sadness
    - action: action_reflective_support

- rule: respond to anxiety
  steps:
    - intent: express_anxiety
    - action: action_reflective_support

- rule: respond to stress
  steps:
    - intent: express_stress
    - action: action_reflective_support

- rule: respond to happiness
  steps:
    - intent: express_happiness
    - action: action_reflective_support

- rule: respond to thanks
  steps:
    - intent: thank
    - action: utter_thanks

- rule: respond to goodbye
  steps:
    - intent: goodbye
    - action: utter_goodbye

- rule: respond to smalltalk
  steps:
    - intent: smalltalk
    - action: utter_smalltalk_default

# =========================
# CRISIS HANDLING (HIGH PRIORITY)
# =========================
- rule: crisis protocol
  condition:
    - active_loop: null
  steps:
    - intent: crisis_help
    - action: utter_crisis_intro
    - action: utter_crisis_hotlines
    - action: utter_crisis_next_steps
    - action: action_offer_appointment_link

# =========================
# APPOINTMENT FORM LIFECYCLE
# =========================
# Single entry point: one empathetic turn, then start the form.
- rule: start appointment form with empathy
  steps:
    - intent: book_appointment
    - action: action_reflective_support
    - action: appointment_form
    - active_loop: appointment_form

# Keep form running on simple affirmations like "yes", "sige", etc.
- rule: keep appointment form on affirm
  condition:
    - active_loop: appointment_form
  steps:
    - intent: affirm
    - action: appointment_form

# Optional: allow user to cancel during the form (deny -> stop)
- rule: cancel appointment form on deny
  condition:
    - active_loop: appointment_form
  steps:
    - intent: deny
    - action: action_deactivate_loop
    - active_loop: null
    - action: utter_goodbye

# Submit the form (after all required slots are filled).
- rule: submit appointment form
  condition:
    - active_loop: appointment_form
  steps:
    - action: appointment_form
    - active_loop: null
    - action: action_submit_appointment

# NOTE:
# You DO NOT need explicit rules to ask each slot.
# Rasa automatically calls utter_ask_{slot} based on your domain and form.

# =========================
# OUT OF SCOPE / FALLBACK
# =========================
- rule: handle out of scope
  steps:
    - intent: out_of_scope
    - action: utter_out_of_scope

- rule: nlu fallback
  steps:
    - intent: nlu_fallback
    - action: utter_fallback
